# Overview

The `smold/system_prompt.py` file is responsible for generating the dynamic system prompt that is provided to the Large Language Model (LLM) at the beginning of a session or when the context changes (e.g., current working directory changes). This prompt provides crucial context to the LLM, including information about the operating environment, current date, working directory contents, and Git repository status (if applicable). The goal is to ground the LLM's responses and enable it to use tools more effectively.

# Key Components

-   **`get_system_prompt(cwd=None) -> str`**:
    *   This is the main function of the module.
    *   It reads a base template from `system_message.txt` (located in the same directory).
    *   It populates placeholders in the template with dynamic information.
    *   **Placeholders replaced**:
        *   `{is_git_repo}`: "Yes" or "No", determined by `is_git_repo()`.
        *   `{platform}`: The current operating system (e.g., "windows", "linux").
        *   `{date}`: The current date, formatted appropriately for the OS.
        *   `{model}`: Hardcoded to "gemini-2.5-pro" (this might be a point of dynamic update in other parts of the system, but here it's static).
        *   `{directory_structure}`: This placeholder is explicitly removed. Instead, a simpler directory listing is appended.
    *   **Appended Information**:
        *   A message indicating the current working directory (`cwd`) and a simple listing of its contents (from `get_simple_directory_listing()`).
        *   If the `cwd` is a Git repository, it appends Git status information (current branch, main branch, status of tracked files, and recent commits) obtained via `get_git_status()`, enclosed in `<context name="gitStatus">` tags.
    *   Returns the fully constructed system prompt string.

-   **`get_directory_structure(start_path, ignore_patterns=None) -> str`**:
    *   *Note: While defined, this function's output is not directly used in the final system prompt generated by `get_system_prompt` because `{directory_structure}` is removed. It was likely intended for a more detailed tree view.*
    *   Generates a string representation of the directory tree starting from `start_path`.
    *   It can ignore specified patterns (e.g., `.git`, `__pycache__`).
    *   Formats the output with indentation to show hierarchy.

-   **`get_simple_directory_listing(cwd) -> str`**:
    *   Provides a flat list of files and directories within the given `cwd`.
    *   Directories are appended with a trailing slash (`/`).
    *   Returns a string with items separated by spaces, or "(empty directory)".
    *   This is the function whose output is actually used for directory contents in the system prompt.

-   **`is_git_repo(path) -> bool`**:
    *   Checks if the given `path` is part of a Git working tree by running `git rev-parse --is-inside-work-tree`.
    *   Returns `True` if it is, `False` otherwise.

-   **`get_git_status(cwd) -> str`**:
    *   Retrieves various Git status details for the repository at `cwd` by running several `git` commands:
        *   Current branch (`git rev-parse --abbrev-ref HEAD`).
        *   Remote main/HEAD branch name (by parsing `git remote show origin`).
        *   File status (`git status --porcelain`).
        *   Recent commit log (`git log --oneline --max-count=5`).
    *   Formats this information into a readable string.

# Important Variables/Constants

-   **`system_message.txt`**: An external template file that forms the base of the system prompt. Its content is read and then customized by `get_system_prompt`.
-   **Placeholders in `system_message.txt`**: Strings like `{platform}`, `{date}`, etc., that are replaced with dynamic values.

# Usage Examples

This module is primarily used internally by `smold/agent.py` when creating or refreshing an agent instance.

```python
# In smold/agent.py (conceptual)
from smold.system_prompt import get_system_prompt
import os

current_working_dir = os.getcwd()
prompt_for_llm = get_system_prompt(cwd=current_working_dir)

# This prompt_for_llm is then set as the system message for the LLM.
# For example:
# agent_model.system_prompt = prompt_for_llm
# or passed to the ContextManager
```

The `system_message.txt` file might look something like this (simplified):

```
You are a helpful AI assistant.
Current OS: {platform}
Today's Date: {date}
This directory is a Git repository: {is_git_repo}
You are using model: {model}

Please assist the user with their tasks.
{directory_structure}
```
*(Note: As implemented, `{directory_structure}` is removed and replaced by a simpler listing appended later by `get_system_prompt`)*.

# Dependencies and Interactions

-   **Standard Libraries**:
    *   `os`: For path operations (basename, join, listdir) and getting current working directory.
    *   `datetime`: To get the current date.
    *   `platform`: To determine the operating system.
    *   `json`: (Not directly used in the final prompt generation but might be relevant if more complex data structures were embedded).
    *   `subprocess`: Crucially used by `is_git_repo` and `get_git_status` to execute external `git` commands and capture their output.
    *   `pathlib`: For more robust path handling (e.g., `Path(start_path).resolve()`).
-   **`system_message.txt` file**: This external file is a hard dependency. `get_system_prompt` will fail if it's not found.
-   **`git` command-line tool**: The functions `is_git_repo` and `get_git_status` depend on the `git` executable being available in the system's PATH. If `git` is not installed or not found, these functions might fail or return incorrect information.
-   **`SmolDAgent` (`smold/agent.py`)**: The `create_agent` and `refresh_agent_context` functions in `agent.py` call `get_system_prompt` to generate or update the system message provided to the LLM.
-   **`ContextManager` (`smold/context_manager.py`)**: The system prompt generated here is typically stored and managed by the `ContextManager` as part of the overall conversational context.

This module plays a critical role in "situating" the LLM within the user's environment, providing it with the necessary context to understand requests related to file systems, Git repositories, and general environmental details. The use of `subprocess` to call `git` makes the Git-related context rich and accurate.
